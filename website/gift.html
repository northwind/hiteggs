<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7" />
        <link href="css/reset.css" rel="stylesheet" type="text/css" />
		<script src="js/jquery-1.4.4.js" type="text/javascript"></script>		
		<script src="js/wb.js" type="text/javascript"></script>
		<title>砸彩蛋</title>
		<style>
			body,iframe{ margin:0px;padding:0px;height:100%;width:100%; }
			html,body{ overflow:hidden; }
			#nav{ background:#DAFECF; height:30px; font-size:18px; line-height:30px; text-align:right; padding:0 100px; }
			#nav button{ font-size:18px; margin-left:100px; }
		</style>
	</head>
	<body>
		<div id="nav" >
			<span id="name">礼品名</span>，需要积分：<span id="cost" style="color:red;" >500</span>
			<button>我要兑换并分享</button>
		</div>
		
		<iframe id="iframe" frameborder="0" width="100%" height="100%" 
			allowtransparency="yes" scrolling="auto" style="border:none;" ></iframe>
		
		<script>
			Request = {
				QueryString: function(item){
					var svalue = location.search.match(new RegExp("[\?\&]" + item + "=([^\&]*)(\&?)", "i"));
					return svalue ? svalue[1] : svalue;
				}
			};
			var id = Request.QueryString("id");
			
			if ( id ){
				$.getJSON( "http://eggs.sinaapp.com/api/index.php/Gift.get", { id : id }, function( gift ){
					if ( gift ){
						setFrame( gift.link );
						$("#name").text( gift.name );
						$("#cost").text( gift.cost );
						$("#ad_words").text( gift.ad_words );
						
						//初始化微博
						var source = "562831874";
						WB.core.load(['connect', 'client'], function() {
						    var cfg = {
						        key: source,
						        xdpath: 'http://eggs.sinaapp.com/xd.html'
						    };
						    WB.connect.init(cfg);
						    WB.client.init(cfg); 
							
							WB.connect.waitReady(onLogin);
							
							//没有登录
							if ( !WB.connect.checkLogin() ){
								$("#nav button").click( function(){
									WB.connect.login();			
								} );
							}
								
							$("#nav button").click( function(){
								//淘宝
								if (gift.type == "1") {
									window.location.href = "buygift.php?gid=" + id;
								}
								else {
									//兑换
									$.post("buygift.php", {
										id: id
									}, function(obj){
										if (obj) {
											//更新状态
											WB.client.parseCMD("/statuses/user_timeline.json", //$userid $id会自动替换 
 function(sResult, bStatus){
												if (bStatus == true) {
													alert("分享成功")
												}
											}, {}, {
												method: 'post'
											});
											alert("哦耶，兑换成功");
											jump();
										}
										else {
											alert("啊哦，你中大奖了，“兑换失败”，请试试其他礼品吧");
											jump();
										}
									});
								}	
							} );
						});
					}else{
						jump();
					}
				} );
				
			}else{
				jump();
			}
			
			function jump (){
				window.location.href = "index.php";
			}
			
			function setFrame( url ){
				var de =  document.documentElement;
				document.getElementById("iframe").src = url;
				document.getElementById("iframe").style.height = ( window.innerHeight || ( de && de.clientHeight ) || document.body.clientHeight ) - 30 + "px";
			}
			
		</script>
	</body>
</html>
